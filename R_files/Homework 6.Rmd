---
title: "Homework 06"
author: "Dylan Petiprin"
date: "2/21/2021"
output: 
  github_document:
    toc: true
    toc_depth: 2
always_allow_html: true
---

## Overview

Increasing high school graduation rates is a primary goal for many
education policy researchers and practitioners. By identifying students
early in high school that are at-risk for dropping out, school districts
can implement targeted interventions designed to increase graduation
rates. This analysis tests whether 9th grade test scores or
freshman-on-track–a binary indicator of whether a freshman has passed
all their core classes and accrued enough credits to move on to
sophomore year–is a better predictor of whether students will end up
graduating.

```{r include = FALSE}
#Use opts_chunk so that you don't get a message every time summarise() is used
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE)

#Load all the necessary packages
library(tidyverse)
#This is for the tables
library(kableExtra)
#This is for the regressions
library(jtools)
#This is to avoid setting the working directory
library(here)
```

```{r}
#Load the data
demographics <- read_csv(here("data", "Demographics.csv"))
attainment <-  read_csv(here("data", "AttainmentIndicators.csv"))
```

## Part One: The Student Sample and Their Outcomes

```{r}
#What percentage of students receive f/r lunch?
demographics %>% 
  mutate(dflunch = ifelse(flunch %in% c("F", "R"), 1, 0)) %>% 
  summarise("Percent Free or Reduced Lunch" = 100*sum(dflunch)/n()) %>% 
#Use kable functions to format the table
   kbl(col.names = c("Percent Free or Reduced Lunch"),
      caption = "Table 1: Free or Reduced Lunch") %>% 
  kable_styling()
  
```

```{r}
#What are the gender breakdowns of the student group?
demographics %>% 
  mutate(gender = factor(gender, 
                         labels = c("Male", "Female"))) %>% 
  group_by(gender) %>% 
  summarise("Number of Students" = n(),
            "Percentage of Total Students" = n()/5) %>% 
  kbl(col.names = c("Gender","Number of Students",
                     "Percentage of Total Students"),
      caption = "Table 2: Gender Breakdown of Student Sample") %>% 
  kable_styling()
  
```

```{r}
#What is the racial composition of the student group?
demographics %>% 
  group_by(racecat) %>% 
  summarise(race_perc = n()/nrow(demographics)) %>% 
#Relabel numbers in race column as the related groups
  mutate(race = factor(racecat, 
                       labels = c("White","African-American",
                                           "Asian/Pacific Islander",
                                           "Latino"))) %>% 
  ggplot() +
  geom_bar(aes(x = race, y = race_perc), stat = "identity") +
   scale_y_continuous(labels = scales::percent) +
  labs(x = "Race", y = "Percentage of Students", 
       title = "Racial Composition of Student Group",
       caption = "Figure 1.1")
```

```{r}
#What is the racial composition of the student group?
demographics %>% 
  mutate(race = factor(racecat, 
                       labels = c("White","African-American",
                                           "Asian/Pacific Islander",
                                           "Latino"))) %>% 
  group_by(race) %>% 
  summarise("Number of Students" = n()) %>% 
  kbl(col.names = c("Race","Number of Students"),
      caption = "Table 3: Student Totals by Race") %>% 
  kable_styling()
```

```{r}
#Find out average indicators of attainment for the sample
attainment %>% 
  summarise("Percent on Track" = 100*sum(dOnTrack9)/n(),
            "Percent Graduated" = 100*sum(regdip4YR)/n(),
            "Average Test Score" = mean(testscore)) %>% 
  kbl(col.names = c("Percent on Track","Percent Graduated","Average Test Score"),
      caption = "Table 4: Student Attainment Indicators") %>% 
  kable_styling(latex_options = "hold_position")
  
```
```{r}
#How many students are at each school?
attainment %>% 
  group_by(schlid) %>% 
  summarise("Number of Students" = n(),
            "Percentage of Total Students" = n()/(5)) %>% 
  kbl(col.names = c("School","Number of Students",
                    "Percentage of Total Students"),
      caption = "Table 5: Student Totals by School") %>% 
  kable_styling()
```

```{r }
#Examine the distribution of ninth grade test scores
attainment %>% 
  ggplot(aes(x = testscore)) +
  geom_histogram(binwidth = 4) +
  labs(x = "Test Score", y = "Number of Students", 
       title = "Distribution of Test Scores for Student Group",
       caption = "Figure 1.2") +
#Add more values to the x axis so that it's easier to identify bins
  scale_x_continuous(breaks = seq(20, 100, 10))
```

Nearly all students in this sample qualify as low-income, with 95.2% of students receiving free or reduced-price lunch (Table 1). These students are predominately people of color, with approximately 80% being African-American and 17% being Latino (Figure 1.1). The gender ratio between male and female students is very close to 1:1 (Table 2). School A is the most represented, making up nearly half of the sample, followed by schools B and C, respectively (Table 5).

Regarding attainment indicators, 75.2% of freshmen in the sample were considered to be on-track. A majority (63.2%) of students went on to attain a high school diploma within 4 years of starting high school, and the average 9th grade test score was approximately 53.4 (Table 4). The distribution of 9th grade test scores is unimodal and shows a slightly positive skew (Figure 1.2).

Overall, this student sample is mainly composed of Black and Latino low-income students, the majority of whom were on track to graduate in 9th grade and ended up doing so. 

## Part Two: Student Outcomes by Demographic

```{r}
#Merge the two data sets, using student id as the key
students_merged <- attainment %>% 
  inner_join(demographics, by = "id")
```

**Note:** Given the small number of White (n = 15) and Asian/Pacific Islander (n = 4) students in the sample, there's reason to believe that many of the following graphs don't provide representative insights for these two groups. 

```{r}
#Visualize test scores by race with boxplot
students_merged %>% 
  mutate(race = factor(racecat, 
                       labels = c("White","African-American",
                                           "Asian/Pacific Islander",
                                           "Latino"))) %>% 
    ggplot(aes(x = race, y = testscore))+
  geom_boxplot() +
  labs(x = "Race", y = "Test Score", 
       title = " Distribution of Test Scores by Race",
       caption = "Figure 2.1")
```

```{r}
#Visualize freshman on track rates by gender and race with geom_bar and multiple colors 
students_merged %>% 
   mutate(race = factor(racecat, 
                       labels = c("White","African-American",
                                           "Asian/Pacific Islander",
                                           "Latino")),
          gender = factor(gender, 
                          labels = c("Male", "Female"))) %>% 
    group_by(race, gender) %>% 
  summarise(perc_ontrack = sum(dOnTrack9)/n())  %>% 
  ggplot()+
  geom_bar(aes(x = race, y = perc_ontrack, fill = gender), 
           stat = "identity",
#Specify the position in order to get adjacent gender columns
           position = "dodge") +
  scale_y_continuous(labels = scales::percent)+
  labs(x = "Race", y = "Percentage of Students", 
       title = "Percentage of On-track Freshmen by Race and Gender",
       caption = "Figure 2.2") +
  coord_flip()
```

```{r }
#Visualize grad rates by gender and race with geom_bar with multiple colors 
students_merged %>% 
   mutate(race = factor(racecat, 
                       labels = c("White","African-American",
                                           "Asian/Pacific Islander",
                                           "Latino")),
          gender = factor(gender, 
                          labels = c("Male", "Female"))) %>% 
    group_by(race, gender) %>% 
  summarise(perc_grad = sum(regdip4YR)/n())  %>% 
  ggplot()+
  geom_bar(aes(x = race, y = perc_grad, fill = gender), 
           stat = "identity",
           position = "dodge") +
   scale_y_continuous(labels = scales::percent) +
  labs(x = "Race", y = "Percentage of Students", 
       title = "Student Graduation Rates by Race and Gender",
       caption = "Figure 2.3")
```

```{r}
#Visualize test scores by school with boxplot
students_merged %>% 
  ggplot(aes(x = schlid, y = testscore))+
  geom_boxplot() +
  labs(x = "School", y = "Test Score", 
       title = " Distribution of Test Scores by School",
       caption = "Figure 2.4")
```

```{r}
#Visualize freshman on track rates by school
students_merged %>% 
  group_by(schlid) %>% 
  summarise(perc_ontrack = sum(dOnTrack9)/n())  %>% 
  ggplot()+
  geom_bar(aes(x = schlid, y = perc_ontrack), 
           stat = "identity") +
  scale_y_continuous(labels = scales::percent)+
  labs(x = "School", y = "Percentage of Students", 
       title = "Percentage of On-track Freshmen by School",
       caption = "Figure 2.5") 
```

```{r}
#visualize grad rates by school
students_merged %>% 
  group_by(schlid) %>% 
  summarise(perc_grad = sum(regdip4YR)/n())  %>% 
  ggplot()+
  geom_bar(aes(x = schlid, y = perc_grad), 
           stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "School", y = "Percentage of Students", 
       title = "Student Graduation Rates by School",
       caption = "Figure 2.6")
```


Median 9th grade test scores increase from African-American, to Latino, to White, to Asian/Pacific Islander. African-American students have the greatest range in test scores, which is perhaps unsurprising given that they make up nearly 80% of the sample (Figure 2.1). Students from School A seem to generally have higher test scores than those from schools B and C. While students from School B have a higher median test score than those from School C, the two schools have approximately the same interquartile range, indicating that many of their students are scoring similarly (Figure 2.4).

Freshman on-track rates follow a similar pattern, with rates increasing from African-American, to Latino, to White, to Asian/Pacific Islander(Figure 2.2), and decreasing from schools A to B to C (Figure 2.6). For African-American and Latino groups, for which we have the greatest number of students, female students seem to score about 10 percentage points higher than their male peers for on-track status. White students are the only group for which we find males exceeding their female peers in freshman on-track status (Figure 2.2).

The data on graduation rates by race show Latino female students graduating at higher rates than both male and female White students, and Latino male students graduating at higher rates than White female students. For African-American and Latino students, female graduation rates are greater than those of male (Figure 2.3). As with the ninth-grade test scores and on-track status, rates for graduation by school descend from A to B to C (Figure 2.6).

## Part 3: Predicting High School Graduation

```{r}
#Create a violin plot of test scores on graduation
students_merged %>% 
  mutate(regdip4YR = factor(regdip4YR,
                            labels = c("Not Graduated", "Graduated"))) %>% 
  ggplot(aes(x = regdip4YR, y = testscore))+
  geom_violin() +
  labs(x = "Graduation Status", y = "Test Score", 
       title = "Test Score Distribution by Graduation Status",
       caption = "Figure 3.1")
#Create a bar chart of freshman on track and graduation
students_merged %>% 
  mutate( dOnTrack9 = factor(dOnTrack9,
                            labels = c("Off-Track", "On-Track"))) %>% 
  group_by(dOnTrack9) %>% 
  summarise(perc_grad = sum(regdip4YR)/n()) %>% 
  ggplot() +
  geom_bar(aes(x = dOnTrack9, y = perc_grad),  stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "On-Track Status", 
       y = "Percentage of Students", 
       title = "Student Graduation Rates by Freshman On-Track Status",
       caption = "Figure 3.2")
```

Looking at Figure 3.1, we see that students who graduate show a greater range in 9th grade test scores. However, the majority of students in both groups seem to have nearly the same scores on average.

Compare this to Figure 3.2, where we find students who are on-track as freshmen seem to graduate by over 50 percentage points more than their off-track peers. This indicates that freshman on-track status is a much better predictor of high school graduation than 9th grade test scores. Let's run some regressions to see if they support this conjecture.

```{r}
#Recode the non-binary categorical variables to convert them into control variables
reg_students_merged <- students_merged %>% 
  mutate(white = if_else(racecat == 1, 1, 0),
         afr_amer = if_else(racecat == 2, 1, 0),
         latino = if_else(racecat == 5, 1, 0),
         fr_lunch = if_else(flunch == "F", 1, 0),
         red_lunch = if_else(flunch == "R", 1, 0),
         schl_a = if_else(schlid == "A", 1, 0),
         schl_b = if_else(schlid == "B", 1, 0))
          
#Subset the data so that the remaining NAs can be converted to 0
reg_students_merged[12:13][is.na(reg_students_merged[12:13])] <- 0
```

### Regression One: Graduation on Test Scores, Controlling for Demographics
```{r }
#Run a regression of graduation on test scores and control variables
summ(lm(regdip4YR ~ testscore + white + afr_amer + latino + 
             fr_lunch + red_lunch + gender + schl_a + schl_b, reg_students_merged)) 
  
```

Regression One controls for the provided demographic variables, and finds that students' 9th grade test scores hold statistically significant predictive power for eventual graduation status at the 95% confidence level. Controlling for demographics, a ten point increase in a student's 9th grade test score is associated with a 10 percentage point increase in the likelihood of graduation. 

### Regression Two: Graduation on Freshman On-Track, Controlling for Demographics
```{r}
#Run a regression of graduation on freshman on track and control variables
summ(lm(regdip4YR ~ dOnTrack9 + white + afr_amer + latino + 
             fr_lunch + red_lunch + gender + schl_a + schl_b, reg_students_merged))
```

Regression Two controls for the provided demographic variables, and still finds that a student's on-track status holds statistically significant predictive power for eventual graduation status at the 99% confidence level. Controlling for demographics, a freshman being on-track is associated with a 51 percentage point increase in the likelihood of graduation. 

**In summary:** While both variables have statistically significant predictive power, the significantly higher R-squared (.23 vs .05) and t-values (11.22 vs. 2.82) for the regression of graduation on freshman on-track, even when controlling for demographic variables, demonstrate that freshman on-track is a much stronger indicator of eventual graduation status than 9th grade test scores. 

















